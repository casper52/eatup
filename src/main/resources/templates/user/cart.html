<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/layout/layout_user}">


<div layout:fragment="content">

	<style>
* {
	margin: 0px;
	padding: 0px;
}


.col-lg-9 {
	item-align: center;
	text-align: center;
	margin: auto;
}

.f1 {
	background-color: #E9CC44;
	height: 100px;
}

.f2 {
	text-align: center;
}

.cartBtn {
	height: 100px;
	width: 100%;
	background-color: transparent;
}

.checked {
	color: orange;
}
</style>
	<!-- content -->

	<div class="col-lg-9">

		<h3>장바구니</h3>
		
		
			<table class="table">
				<thead class="thead-dark">
					<tr>
						<th scope="col"><div class="form-check form-check-inline"> <input class="selectAll form-check-input" type="checkbox" id="inlineCheckbox1" value="option1"  checked="checked">
  							<label class="form-check-label" for="inlineCheckbox1"></label></div></th>
						<th scope="col">메뉴</th>
						<th scope="col">수량</th>
						<th scope="col">가격</th>
						<th scope="col">변경</th>
					</tr>
				</thead>
				<tbody>
					<tr class="cartList" th:each="cart ,index: ${cart}" th:data-idx="${index.index}">
						<td><div class="form-check form-check-inline"> <input class="selectOne form-check-input" name="ckBox" type="checkbox" id="inlineCheckbox1" value="option1"  checked="checked">
  							<label class="form-check-label" for="inlineCheckbox1"></label></div></td>
						<td th:text="${cart.mname}"></td>
						<td><input th:value="${cart.quantity}" size="1" type="number" class="qty form-control" min="1" max="100" th:data-idx="${index.index}"></td>
						<td id="price" th:text="|${cart.mprice}원|"></td>
						<td><button class="editBtn btn btn-outline-warning">수정</button></td>
					</tr>
					
					<tr>
					<td></td><td></td><td></td><td></td>
					<td> <button class="delBtn btn btn-danger">전체삭제</button></td>
					</tr>
				</tbody>
				
			</table>

	<div class="col-lg-9">
				<h3>총 주문 금액</h3>
				<div class="facet f2" th:each="cart : ${cart}">
				<input type="hidden" class="getPrice" th:value="${cart.totalPrice}" th:attr="name='totlaPrice'">
				</div>
				<h4 class="totalPrice"></h4>
	</div>
		   <div class="col-md-5">
		<!-- end content -->
			</div>
	      		<div class="wrapper">
      			<div class="facet f1"> <button class="cartBtn btn btn-warning" th:onclick="|window.location.href='@{/user/pay(sno=${sno})}'|">주문하기</button></div>
      			</div>
      			
      		
      	
      		
</div>

<th:block layout:fragment="script">
<script th:inline="javascript">
window.onload = function(){
	
	var getCookie = $.cookie('cart');
	var cart = [[${cart}]];
	var arr = new Array();
	var idx = $(".cartList").data('idx');
    var sumPrice=0;
	
	console.log("카트리스트:" + $(".cartList").length);
	

	$(".qty").attr("disabled",true); 

	
	//체크박스 전체선택, 해제
	$(".selectAll").click(function(){
		//클릭
		if($(".selectOne").prop("checked")){
			$("input[name=ckBox]").prop("checked", false);
			
			//메뉴 선택 삭제
			if( $(".delBtn").html() == '전체삭제' ) {
			      $(".delBtn").html('선택삭제');
			      
			      $(".delBtn").on("click", function(){
			    	  
			    	  delCart();
			      });
			   		
			}; //delBtn if end

		//논클릭
		}else{
			$("input[name=ckBox]").prop("checked", true);


		} //end if-else
	}) //end checkbox
	
	//메뉴 전체 삭제
    $(".delBtn").on("click", function(){
  	  delCart();
    });
	
	

	//총 주문금액
	$(".totalPrice").html(function(){
		var price = 0;	
		
		//가격
		$(".getPrice").each(function(){
			
			price += parseInt($(this).context.value);
		});
		
		return price+'원';
	
	}); //end totalPrice
	
	
	//Edit 버튼 클릭
	$(".editBtn").on("click", function(e){
		e.preventDefault();
		var inp=$(this).parent().parent().find('td input')[1];
		inp.removeAttribute( 'disabled');
		
		//edit status
		if( $(this).html() == '수정' ) {
		      $(this).html('완료');
		    } 
		
		//done status
		   else {
		      $(this).html('수정');
		      inp.setAttribute( 'disabled','disabled');
		      

		   
		      // json으로 Data변환
		   		for(var i = 0; i < cart.length; i++){
		   		var qty=$('input[data-idx="'+i+'"]').val();
				
		   		var jsonData = new Object();
				jsonData.sno = [[${sno}]];
				jsonData.mno =cart[i].mno;
				jsonData.quantity =qty;
				sumPrice+=parseInt(cart[i].mprice)*parseInt(qty);
	
				arr.push(jsonData);
		   		}
				
				var json = JSON.stringify(arr);
		      
		  	$.cookie('cart', json, { expires: 1, path: '/'}); 	       
			console.log("cookie : " + $.cookie('cart')); 
			arr = new Array();
			$('.totalPrice').html(sumPrice+"원");
		    }

	}); //end editBtn
	
	// delCart confirm
   function delCart(){
   	  var choose = confirm("메뉴를 삭제하시겠습니까?");
   	  if (choose == true) {

   		$(".cartList").remove();
   		var jsonData = new Object();
   		$('.totalPrice').remove();
   		
   		
   		
   		
   		  
   		
   		  
   	  }else{

   	  }
   	  console.log(choose);
   	}; //end delCart


	
	
		


	
	
}; // end window.onload
	
	
	
	
	

</script>
</th:block>